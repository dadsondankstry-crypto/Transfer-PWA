<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transfer PWA V2</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; max-width: 600px; margin: auto; }
        input, button { padding: 15px; margin: 10px 0; width: 100%; box-sizing: border-box; font-size: 16px; }
        #my-id { font-weight: bold; color: blue; word-break: break-all; background: #f0f0f0; padding: 10px; border-radius: 5px; user-select: all;}
        #status { margin-top: 20px; font-weight: bold; padding: 10px; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>

    <h2>TransferÃªncia PWA</h2>
    
    <p>Seu ID (Toque para copiar):</p>
    <div id="my-id" onclick="copyId()">Gerando ID...</div>

    <hr>

    <p>Conectar com outro dispositivo:</p>
    <input type="text" id="remote-id" placeholder="Cole o ID do outro dispositivo aqui">
    <button onclick="pasteId()">ðŸ“‹ Colar ID (Celular)</button>
    <button onclick="connect()">ðŸ”— Conectar</button>

    <div id="file-area" style="display:none;">
        <hr>
        <h3>Enviar Arquivo</h3>
        <input type="file" id="file-input">
        <button onclick="sendFile()">ðŸ“¤ Enviar</button>
    </div>

    <div id="status">Aguardando...</div>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }

        const peer = new Peer({
            debug: 2 // Mostra erros no console
        }); 
        let conn;

        // Mostra o ID
        peer.on('open', (id) => {
            document.getElementById('my-id').innerText = id;
            document.getElementById('status').innerText = "Pronto para conectar.";
        });

        // REGRAS DE ERRO (Isso faltava no anterior)
        peer.on('error', (err) => {
            console.error(err);
            let msg = "Erro desconhecido.";
            if (err.type === 'peer-unavailable') msg = "ID nÃ£o encontrado! Verifique se copiou certo.";
            if (err.type === 'browser-incompatible') msg = "Navegador incompatÃ­vel.";
            if (err.type === 'network') msg = "Erro de rede / Firewall bloqueando.";
            if (err.type === 'disconnected') msg = "Desconectado do servidor.";
            
            document.getElementById('status').innerText = "ERRO: " + msg;
            document.getElementById('status').className = "error";
            alert("ERRO: " + msg);
        });

        peer.on('disconnected', () => {
            document.getElementById('status').innerText = "ConexÃ£o perdida. Recarregue a pÃ¡gina.";
        });

        // Receber conexÃ£o
        peer.on('connection', (connection) => {
            handleConnection(connection);
        });

        function connect() {
            const remoteId = document.getElementById('remote-id').value.trim();
            if (!remoteId) return alert("Cole o ID primeiro!");
            
            document.getElementById('status').innerText = "Tentando conectar...";
            const connection = peer.connect(remoteId);
            handleConnection(connection);
        }

        function handleConnection(connection) {
            conn = connection;
            
            conn.on('open', () => {
                document.getElementById('status').innerText = "Conectado com sucesso!";
                document.getElementById('status').className = "success";
                document.getElementById('file-area').style.display = 'block';
            });

            conn.on('close', () => {
                document.getElementById('status').innerText = "O outro dispositivo desconectou.";
                document.getElementById('file-area').style.display = 'none';
            });

            conn.on('error', (err) => {
                alert("Erro na conexÃ£o: " + err);
            });

            // Receber Arquivo
            conn.on('data', (data) => {
                const blob = new Blob([data.file], { type: data.type });
                const url = URL.createObjectURL(blob);
                
                // Cria link de download
                const a = document.createElement('a');
                a.href = url;
                a.download = data.name;
                a.innerText = "ðŸ“¥ Baixar: " + data.name;
                a.style.display = "block";
                a.style.marginTop = "10px";
                a.style.fontSize = "18px";
                a.style.background = "#d4edda";
                a.style.padding = "10px";
                
                document.getElementById('file-area').appendChild(a);
                document.getElementById('status').innerText = "Arquivo recebido!";
            });
        }

        function sendFile() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            if (file && conn) {
                document.getElementById('status').innerText = "Enviando " + file.name + "...";
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    conn.send({
                        file: e.target.result,
                        name: file.name,
                        type: file.type
                    });
                    document.getElementById('status').innerText = "Arquivo enviado!";
                };
                reader.readAsArrayBuffer(file);
            }
        }

        // FunÃ§Ãµes auxiliares de Copiar/Colar
        function copyId() {
            const idText = document.getElementById('my-id').innerText;
            navigator.clipboard.writeText(idText).then(() => alert("ID Copiado!"));
        }

        async function pasteId() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('remote-id').value = text;
            } catch (err) {
                alert("PermissÃ£o para colar negada ou nÃ£o suportada. Cole manualmente.");
            }
        }
    </script>
</body>
</html>
