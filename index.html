<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transfer PWA Pro</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; text-align: center; max-width: 500px; margin: auto; background-color: #f4f4f9; }
        h2 { color: #333; }
        
        /* Estilos dos Cards */
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* Inputs e Bot√µes */
        input { padding: 12px; width: 100%; box-sizing: border-box; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        button { padding: 12px; width: 100%; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: 0.3s; margin-bottom: 5px; font-weight: bold; }
        
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #545b62; }
        
        .btn-action { background-color: #28a745; color: white; } /* Verde para conectar/enviar */
        
        /* √Årea do ID */
        #my-id { font-family: monospace; font-size: 18px; color: #007bff; background: #e9ecef; padding: 10px; border-radius: 5px; word-break: break-all; margin-bottom: 10px; border: 1px dashed #ccc;}

        /* Status */
        #status-box { padding: 15px; border-radius: 8px; font-weight: bold; margin-top: 10px; }
        .status-loading { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .status-ready { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .status-connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* √Årea de arquivo */
        #file-area { display: none; margin-top: 20px; border-top: 2px dashed #ddd; padding-top: 20px; }
    </style>
</head>
<body>

    <h2>üì≤ Transfer√™ncia PWA</h2>

    <div id="status-box" class="status-loading">
        ‚è≥ Iniciando sistema...
    </div>

    <div class="card">
        <p>Seu C√≥digo (ID):</p>
        <div id="my-id">Gerando...</div>
        <button class="btn-secondary" onclick="copyId()">üìã Copiar meu ID</button>
    </div>

    <div class="card">
        <p>Conectar com o outro:</p>
        <input type="text" id="remote-id" placeholder="Cole o ID do parceiro aqui...">
        <div style="display: flex; gap: 10px;">
            <button class="btn-secondary" onclick="pasteId()" style="flex: 1;">üìã Colar ID</button>
            <button class="btn-action" onclick="connect()" style="flex: 1;">üîó Conectar</button>
        </div>
    </div>

    <div id="file-area" class="card">
        <h3>üìÇ Enviar Arquivo</h3>
        <input type="file" id="file-input">
        <button class="btn-primary" onclick="sendFile()">üöÄ Enviar Arquivo</button>
        <div id="download-area"></div>
    </div>

    <script>
        // PWA Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }

        const peer = new Peer({ debug: 2 });
        let conn;
        const statusBox = document.getElementById('status-box');

        // FUN√á√ÉO PARA ATUALIZAR STATUS VISUALMENTE
        function updateStatus(msg, type) {
            statusBox.innerText = msg;
            statusBox.className = ''; // Limpa classes anteriores
            statusBox.classList.add(type); // Adiciona a nova classe
        }

        // 1. QUANDO O APP FICA PRONTO (ONLINE)
        peer.on('open', (id) => {
            document.getElementById('my-id').innerText = id;
            updateStatus("üü¢ Online! Aguardando conex√£o...", "status-ready");
        });

        // 2. TRATAMENTO DE ERROS
        peer.on('error', (err) => {
            console.error(err);
            let msg = "Erro desconhecido.";
            if (err.type === 'peer-unavailable') msg = "‚ùå ID n√£o encontrado! Verifique o c√≥digo.";
            if (err.type === 'browser-incompatible') msg = "‚ùå Navegador incompat√≠vel.";
            if (err.type === 'network') msg = "‚ùå Erro de rede. Firewall ou 4G bloqueando.";
            if (err.type === 'disconnected') msg = "‚ùå Desconectado do servidor.";
            
            updateStatus(msg, "status-error");
            alert(msg); // Alerta visual extra
        });

        peer.on('disconnected', () => {
            updateStatus("‚ö†Ô∏è Conex√£o perdida. Recarregue a p√°gina.", "status-error");
        });

        // 3. QUANDO ALGU√âM CONECTA EM VOC√ä
        peer.on('connection', (connection) => {
            handleConnection(connection);
        });

        // 4. QUANDO VOC√ä CLICA EM CONECTAR
        function connect() {
            const remoteId = document.getElementById('remote-id').value.trim();
            if (!remoteId) return alert("Cole o ID primeiro!");
            
            updateStatus("üîÑ Tentando conectar...", "status-loading");
            const connection = peer.connect(remoteId);
            handleConnection(connection);
        }

        // L√ìGICA DA CONEX√ÉO
        function handleConnection(connection) {
            conn = connection;
            
            conn.on('open', () => {
                updateStatus("‚úÖ Conectado! Pode transferir.", "status-connected");
                document.getElementById('file-area').style.display = 'block';
            });

            conn.on('close', () => {
                updateStatus("‚ö†Ô∏è O outro dispositivo saiu.", "status-error");
                document.getElementById('file-area').style.display = 'none';
            });

            conn.on('error', (err) => alert("Erro na conex√£o: " + err));

            // Receber Arquivo
            conn.on('data', (data) => {
                const blob = new Blob([data.file], { type: data.type });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = data.name;
                a.innerText = "üì• Baixar: " + data.name;
                a.style.display = "block";
                a.style.marginTop = "10px";
                a.style.padding = "10px";
                a.style.background = "#e2e6ea";
                a.style.borderRadius = "5px";
                a.style.textDecoration = "none";
                a.style.color = "#333";
                
                document.getElementById('download-area').appendChild(a);
                updateStatus("‚úÖ Arquivo recebido!", "status-connected");
            });
        }

        // ENVIAR ARQUIVO
        function sendFile() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            if (file && conn) {
                updateStatus("üì§ Enviando " + file.name + "...", "status-loading");
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    conn.send({
                        file: e.target.result,
                        name: file.name,
                        type: file.type
                    });
                    updateStatus("‚úÖ Arquivo enviado com sucesso!", "status-connected");
                };
                reader.readAsArrayBuffer(file);
            } else {
                alert("Selecione um arquivo ou verifique a conex√£o.");
            }
        }

        // BOT√ïES COPIAR E COLAR
        function copyId() {
            const idText = document.getElementById('my-id').innerText;
            if(idText === "Gerando..." || !idText) return;
            navigator.clipboard.writeText(idText)
                .then(() => alert("ID Copiado para a √°rea de transfer√™ncia!"))
                .catch(() => alert("Erro ao copiar. Tente selecionar e copiar manualmente."));
        }

        async function pasteId() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('remote-id').value = text;
            } catch (err) {
                alert("O navegador bloqueou a colagem autom√°tica. Por favor, cole manualmente segurando no campo de texto.");
            }
        }
    </script>
</body>
</html>
