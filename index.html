<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirDrop PWA Ultra - Com Hist√≥rico</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --bg: #f4f4f9; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; padding: 20px; text-align: center; max-width: 500px; margin: auto; background: var(--bg); color: #333; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        input[type="text"] { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-green { background: var(--success); color: white; }
        .btn-red { background: var(--danger); color: white; }
        .btn-gray { background: #6c757d; color: white; }

        #status-box { padding: 15px; border-radius: 10px; font-weight: bold; margin-bottom: 10px; }
        .ready { background: #d1ecf1; color: #0c5460; }
        .connected { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }

        .drop-zone { border: 2px dashed #ccc; border-radius: 12px; padding: 25px; background: #fafafa; cursor: pointer; margin-bottom: 10px; }
        #file-list-preview { text-align: left; font-size: 12px; background: #fffbe6; padding: 10px; border-radius: 8px; margin: 10px 0; display: none; border: 1px solid #ffe58f; }
        #chat-box { height: 120px; overflow-y: auto; background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 10px; margin-bottom: 10px; text-align: left; font-size: 13px; }
        
        /* Estilo do Hist√≥rico */
        .preview-card { display: flex; align-items: center; background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 10px; margin-top: 10px; text-align: left; gap: 10px; }
        .preview-img { width: 40px; height: 40px; object-fit: cover; border-radius: 6px; }
        .history-label { font-size: 10px; font-weight: bold; text-transform: uppercase; display: block; }
        
        #p-container { display:none; background:#eee; border-radius:10px; overflow:hidden; margin-bottom:10px; }
        #progress-bar { width:0%; height:20px; background:var(--primary); color:white; font-size:12px; line-height:20px; transition: width 0.1s; text-align: center; }
    </style>
</head>
<body>

    <h2>üì≤ AirDrop PWA Ultra</h2>
    <div id="status-box" class="ready">‚è≥ Iniciando sinal...</div>

    <div class="card">
        <small>Seu ID:</small>
        <div id="my-id" style="font-weight: bold; color: var(--primary); margin-bottom: 10px;">...</div>
        <div style="display: flex; gap: 8px;">
            <button class="btn-blue" style="flex:1" onclick="copyId()">üìã Copiar</button>
            <button class="btn-gray" onclick="toggleQR()">üì± QR</button>
        </div>
        <div id="qrcode-container" style="display:none; margin-top:10px;"><div id="qrcode" style="display:inline-block;"></div></div>
    </div>

    <div class="card">
        <input type="text" id="remote-id" placeholder="ID do parceiro">
        <button class="btn-green" onclick="connect()">üîó Conectar Agora</button>
    </div>

    <div id="transfer-area" class="card" style="display: none;">
        <div id="chat-box"></div>
        <div style="display: flex; gap: 5px; margin-bottom: 15px;">
            <input type="text" id="chat-input" placeholder="Mensagem...">
            <button class="btn-blue" onclick="sendChat()" style="width: 80px;">Enviar</button>
        </div>

        <div id="drop-zone" class="drop-zone">üñ±Ô∏è Arraste ou Clique para Selecionar</div>
        <input type="file" id="file-input" multiple style="display: none;">
        
        <div id="file-list-preview"></div>
        
        <div id="p-container">
            <div id="progress-bar">0%</div>
        </div>
        
        <button class="btn-blue" onclick="sendFile()">üöÄ Enviar Arquivos</button>
        
        <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
        <h4 style="margin: 0; text-align: left;">üïí Hist√≥rico de Transfer√™ncia</h4>
        <div id="download-area"></div>
        <button class="btn-red" onclick="clearHistory()" style="margin-top: 15px; font-size: 11px;">üóëÔ∏è Limpar Hist√≥rico</button>
    </div>

    <script>
        const peer = new Peer({ debug: 2 });
        let conn, qrGenerated = false;
        const fi = document.getElementById('file-input');
        const dz = document.getElementById('drop-zone');

        peer.on('open', id => {
            document.getElementById('my-id').innerText = id;
            updateStatus("üü¢ Online", "ready");
        });

        peer.on('connection', c => handleConnection(c));

        function connect() {
            const rId = document.getElementById('remote-id').value.trim();
            if (rId) handleConnection(peer.connect(rId));
        }

        function handleConnection(connection) {
            conn = connection;
            conn.on('open', () => {
                updateStatus("‚úÖ Conectado!", "connected");
                document.getElementById('transfer-area').style.display = 'block';
            });
            conn.on('data', data => handleData(data));
        }

        async function handleData(data) {
            if (data.type === 'CHAT') renderChat("Parceiro", data.msg);
            else if (data.type === 'CONFIRMATION') {
                renderChat("Sistema", `‚úÖ Recebido pelo parceiro: ${data.fileName}`);
            } else {
                const blob = new Blob([data.file], { type: data.type });
                const url = URL.createObjectURL(blob);
                
                addToHistory(data.name, data.type, url, false);

                const a = document.createElement('a');
                a.href = url; a.download = data.name;
                a.click();
                
                conn.send({ type: 'CONFIRMATION', fileName: data.name });
            }
        }

        fi.onchange = () => updateFilePreview();
        dz.onclick = () => fi.click();
        dz.ondragover = e => { e.preventDefault(); dz.style.borderColor = "var(--primary)"; };
        dz.ondragleave = () => { dz.style.borderColor = "#ccc"; };
        dz.ondrop = e => { e.preventDefault(); dz.style.borderColor = "#ccc"; fi.files = e.dataTransfer.files; updateFilePreview(); };

        function updateFilePreview() {
            const list = document.getElementById('file-list-preview');
            const files = fi.files;
            if (files.length > 0) {
                list.style.display = 'block';
                list.innerHTML = `<strong>Pronto para enviar:</strong><br>`;
                Array.from(files).forEach(f => {
                    list.innerHTML += `‚Ä¢ ${f.name}<br>`;
                });
            } else { list.style.display = 'none'; }
        }

        function addToHistory(name, type, url, isSent) {
            const area = document.getElementById('download-area');
            const card = document.createElement('div');
            card.className = 'preview-card';
            card.style.borderLeft = isSent ? "5px solid var(--primary)" : "5px solid var(--success)";
            
            card.innerHTML = `
                ${type.startsWith('image/') ? `<img src="${url}" class="preview-img">` : 'üìÑ'}
                <div style="flex-grow:1">
                    <span class="history-label">${isSent ? 'Enviado' : 'Recebido'}</span>
                    <strong style="font-size:12px;">${name}</strong>
                </div>
                ${!isSent ? `<a href="${url}" download="${name}" style="text-decoration:none; font-size:20px;">üíæ</a>` : '<span style="font-size:12px">‚úÖ</span>'}
            `;
            area.prepend(card);
        }

        function sendFile() {
            const files = fi.files;
            if (!files.length || !conn) return;
            const bar = document.getElementById('progress-bar');
            document.getElementById('p-container').style.display = 'block';

            Array.from(files).forEach((f, i) => {
                const reader = new FileReader();
                reader.onprogress = e => {
                    if(e.lengthComputable) {
                        const pct = Math.round((e.loaded / e.total) * 100);
                        bar.style.width = pct + '%';
                        bar.innerText = `Enviando ${f.name}: ${pct}%`;
                    }
                };
                reader.onload = e => {
                    conn.send({ file: e.target.result, name: f.name, type: f.type });
                    
                    // Adiciona ao seu hist√≥rico local
                    const localUrl = f.type.startsWith('image/') ? URL.createObjectURL(f) : "";
                    addToHistory(f.name, f.type, localUrl, true);

                    if (i === files.length - 1) {
                        bar.style.background = "var(--success)";
                        bar.innerText = "üöÄ 100% - Arquivos Enviados!";
                        setTimeout(() => { 
                            document.getElementById('p-container').style.display='none'; 
                            document.getElementById('file-list-preview').style.display='none';
                            fi.value = "";
                            bar.style.width = "0%";
                            bar.style.background = "var(--primary)";
                        }, 4000);
                    }
                };
                reader.readAsArrayBuffer(f);
            });
        }

        function sendChat() {
            const i = document.getElementById('chat-input');
            if (i.value.trim() && conn?.open) { conn.send({ type: 'CHAT', msg: i.value }); renderChat("Voc√™", i.value); i.value = ''; }
        }
        function renderChat(s, m) {
            const b = document.getElementById('chat-box');
            const d = document.createElement('div');
            d.innerHTML = `<span style="color:${s==='Voc√™'?'blue':'green'}"><strong>${s}:</strong></span> ${m}`;
            b.appendChild(d); b.scrollTop = b.scrollHeight;
        }
        function updateStatus(t, c) { const s = document.getElementById('status-box'); s.innerText = t; s.className = c; }
        function copyId() { navigator.clipboard.writeText(document.getElementById('my-id').innerText); alert("ID Copiado!"); }
        function toggleQR() { const c = document.getElementById('qrcode-container'); c.style.display = c.style.display==='none'?'block':'none'; if(!qrGenerated){ new QRCode(document.getElementById("qrcode"), document.getElementById('my-id').innerText); qrGenerated=true; } }
        function clearHistory() { document.getElementById('download-area').innerHTML = ''; }
    </script>
</body>
</html>
